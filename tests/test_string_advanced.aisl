(module test_string_advanced
  (import string_utils)
  (fn split_csv text string delim string -> array
    (ret (split text delim)))
  
  (test-spec split_csv
    (case "split CSV with spaces"
      (mock (split "  apple  , banana , cherry  " ",") "csv_array")
      (input "  apple  , banana , cherry  " ",")
      (expect "csv_array"))
    (case "split simple CSV"
      (mock (split "John,25,Engineer" ",") "simple_csv")
      (input "John,25,Engineer" ",")
      (expect "simple_csv")))
  
  (fn trim_string text string -> string
    (ret (trim text)))
  
  (test-spec trim_string
    (case "trim padded text"
      (mock (trim "  apple  ") "apple")
      (input "  apple  ")
      (expect "apple"))
    (case "trim with multiple spaces"
      (mock (trim "  Hello   World!  ") "Hello   World!")
      (input "  Hello   World!  ")
      (expect "Hello   World!")))
  
  (fn replace_text text string old string new string -> string
    (ret (replace text old new)))
  
  (test-spec replace_text
    (case "replace fox with dog"
      (mock (replace "The quick brown fox" "fox" "dog") "The quick brown dog")
      (input "The quick brown fox" "fox" "dog")
      (expect "The quick brown dog"))
    (case "replace double spaces"
      (mock (replace "Hello   World!" "  " " ") "Hello  World!")
      (input "Hello   World!" "  " " ")
      (expect "Hello  World!"))
    (case "replace template variable"
      (mock (replace "Hello {{name}}, welcome!" "{{name}}" "Alice") "Hello Alice, welcome!")
      (input "Hello {{name}}, welcome!" "{{name}}" "Alice")
      (expect "Hello Alice, welcome!")))
  
  (fn check_contains text string search string -> bool
    (ret (contains text search)))
  
  (test-spec check_contains
    (case "contains dog"
      (mock (contains "The quick brown dog" "dog") true)
      (input "The quick brown dog" "dog")
      (expect true))
    (case "does not contain fox"
      (mock (contains "The quick brown dog" "fox") false)
      (input "The quick brown dog" "fox")
      (expect false)))
  
  (fn concat_strings str1 string str2 string -> string
    (ret (concat str1 str2)))
  
  (test-spec concat_strings
    (case "concat with Name label"
      (mock (string_concat "Name: " "John") "Name: John")
      (input "Name: " "John")
      (expect "Name: John"))
    (case "concat with Age label"
      (mock (string_concat "Age: " "25") "Age: 25")
      (input "Age: " "25")
      (expect "Age: 25")))
  
  (meta-note "Tests advanced string operations - CSV parsing, trimming, template replacement, sanitization with atomic functions"))
