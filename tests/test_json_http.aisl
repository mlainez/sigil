(mod test_json_http
  (fn fetch_url url string -> string
    (ret (call http_get url)))
  
  (test-spec fetch_url
    (case "fetch JSON from API"
      (mock (http_get "http://httpbin.org/json") "http_response_1")
      (input "http://httpbin.org/json")
      (expect "http_response_1")))
  
  (fn get_response_body response string -> string
    (ret (call http_get_body response)))
  
  (test-spec get_response_body
    (case "extract body from HTTP response"
      (mock (http_get_body "http_response_1") "{\"key\":\"value\"}")
      (input "http_response_1")
      (expect "{\"key\":\"value\"}")))
  
  (fn parse_json_string json_str string -> json
    (ret (call json_parse json_str)))
  
  (test-spec parse_json_string
    (case "parse JSON string to object"
      (mock (json_parse "{\"key\":\"value\"}") "json_obj_1")
      (input "{\"key\":\"value\"}")
      (expect "json_obj_1")))
  
  (fn get_json_type json_data json -> string
    (ret (call json_type json_data)))
  
  (test-spec get_json_type
    (case "get type of JSON object"
      (mock (json_type "json_obj_1") "object")
      (input "json_obj_1")
      (expect "object"))
    (case "get type of JSON array"
      (mock (json_type "json_arr_1") "array")
      (input "json_arr_1")
      (expect "array")))
  
  (fn stringify_json json_data json -> string
    (ret (call json_stringify json_data)))
  
  (test-spec stringify_json
    (case "stringify JSON object back"
      (mock (json_stringify "json_obj_1") "{\"key\":\"value\"}")
      (input "json_obj_1")
      (expect "{\"key\":\"value\"}")))
  
  (meta-note "Tests JSON and HTTP integration with atomic functions - each function has single external call and single mock"))
