(mod test_regex
  (fn compile_regex ((pattern string)) -> string
    (ret (call regex_compile pattern)))
  
  (test-spec compile_regex
    (case "compile digit pattern"
      (mock (regex_compile "[0-9]+") "regex_1")
      (input "[0-9]+")
      (expect "regex_1")))
  
  (fn match_regex ((pattern string) (text string)) -> bool
    (ret (call regex_match pattern text)))
  
  (test-spec match_regex
    (case "match digits in text"
      (mock (regex_match "regex_1" "abc123def") true)
      (input "regex_1" "abc123def")
      (expect true))
    (case "no match without digits"
      (mock (regex_match "regex_1" "abcdef") false)
      (input "regex_1" "abcdef")
      (expect false)))
  
  (fn find_first_match ((pattern string) (text string)) -> string
    (ret (call regex_find pattern text)))
  
  (test-spec find_first_match
    (case "find first digit sequence"
      (mock (regex_find "regex_1" "abc123def456") "123")
      (input "regex_1" "abc123def456")
      (expect "123")))
  
  (fn find_all_matches ((pattern string) (text string)) -> array
    (ret (call regex_find_all pattern text)))
  
  (test-spec find_all_matches
    (case "find all digit sequences"
      (mock (regex_find_all "regex_1" "abc123def456ghi789") "matches_array")
      (input "regex_1" "abc123def456ghi789")
      (expect "matches_array")))
  
  (fn replace_matches ((pattern string) (text string) (replacement string)) -> string
    (ret (call regex_replace pattern text replacement)))
  
  (test-spec replace_matches
    (case "replace digits with XXX"
      (mock (regex_replace "regex_1" "abc123def456" "XXX") "abcXXXdefXXX")
      (input "regex_1" "abc123def456" "XXX")
      (expect "abcXXXdefXXX")))
  
  (fn check_string_equality ((str1 string) (str2 string)) -> bool
    (ret (call str_eq str1 str2)))
  
  (test-spec check_string_equality
    (case "strings are equal"
      (mock (str_eq "123" "123") true)
      (input "123" "123")
      (expect true))
    (case "strings not equal"
      (mock (str_eq "abcXXXdefXXX" "abc123def456") false)
      (input "abcXXXdefXXX" "abc123def456")
      (expect false)))
  
  (meta-note "Tests regex operations atomically - compile, match, find, find_all, replace with mocked regex engine"))
