(mod test_tcp
  (fn connect_tcp ((host string) (port i32)) -> string
    (ret (call tcp_connect host port)))
  
  (test-spec connect_tcp
    (case "connect to example.com port 80"
      (mock (tcp_connect "example.com" 80) "socket_1")
      (input "example.com" 80)
      (expect "socket_1")))
  
  (fn send_tcp_data ((sock string) (data string)) -> i32
    (call tcp_send sock data)
    (ret 0))
  
  (test-spec send_tcp_data
    (case "send HTTP GET request"
      (mock (tcp_send "socket_1" "GET / HTTP/1.0\r\nHost: example.com\r\n\r\n") 0)
      (input "socket_1" "GET / HTTP/1.0\r\nHost: example.com\r\n\r\n")
      (expect 0)))
  
  (fn receive_tcp_data ((sock string) (max_bytes i32)) -> string
    (ret (call tcp_receive sock max_bytes)))
  
  (test-spec receive_tcp_data
    (case "receive HTTP response"
      (mock (tcp_receive "socket_1" 1024) "HTTP/1.0 200 OK\r\nContent-Type: text/html\r\n\r\n<html>...</html>")
      (input "socket_1" 1024)
      (expect "HTTP/1.0 200 OK\r\nContent-Type: text/html\r\n\r\n<html>...</html>")))
  
  (fn close_tcp ((sock string)) -> i32
    (call tcp_close sock)
    (ret 0))
  
  (test-spec close_tcp
    (case "close TCP connection"
      (mock (tcp_close "socket_1") 0)
      (input "socket_1")
      (expect 0)))
  
  (meta-note "Tests TCP network operations atomically - connect, send, receive, close with mocked socket calls"))
