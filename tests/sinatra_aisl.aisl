(mod sinatra_aisl
  (fn route_hello_json () -> string
    (ret "HTTP/1.1 200 OK\r\nContent-Type: application/json\r\nContent-Length: 33\r\n\r\n{\"message\": \"Hello from AISL\"}"))

  (fn route_hello_html () -> string
    (ret "HTTP/1.1 200 OK\r\nContent-Type: text/html\r\nContent-Length: 43\r\n\r\n<html><body>Hello from AISL</body></html>"))

  (fn route_not_found () -> string
    (ret "HTTP/1.1 404 Not Found\r\nContent-Type: text/html\r\nContent-Length: 49\r\n\r\n<html><body><h1>404 Not Found</h1></body></html>"))

  (fn handle_request ((request string)) -> string
    (set has_json bool (call string_contains request "/hello.json"))
    (if has_json found_json)
    (set has_html bool (call string_contains request "/hello"))
    (if has_html found_html)
    (ret (call route_not_found))
    (label found_json)
    (ret (call route_hello_json))
    (label found_html)
    (ret (call route_hello_html)))

  (fn handle_connection ((client_sock string)) -> i32
    (set request string (call tcp_receive client_sock 4096))
    (set response string (call handle_request request))
    (set sent i32 (call tcp_send client_sock response))
    (call tcp_close client_sock)
    (ret 0))

  (fn start_server ((port i32)) -> i32
    (call print "========================================")
    (call print "  AISL Web Server - Sinatra Style")
    (call print "========================================")
    (call print "")
    (set server_sock string (call tcp_listen port))
    (call print "Server listening on http://localhost:8080")
    (call print "")
    (call print "Routes:")
    (call print "  GET /hello       -> HTML response")
    (call print "  GET /hello.json  -> JSON response")
    (call print "")
    (label accept_loop)
    (set client_sock string (call tcp_accept server_sock))
    (call handle_connection client_sock)
    (goto accept_loop))

  (fn main () -> i32
    (ret (call start_server 8080))))
