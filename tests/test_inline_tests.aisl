(mod math_with_tests

  (fn divide ((a i32) (b i32)) -> result<i32,string>
    (if (call op_eq_i32 b 0)
      (ret (err "Division by zero"))
      (ret (ok (call op_div_i32 a b)))))
  
  (test-spec divide
    (case "normal division"
      (input 10 5)
      (expect (ok 2)))
    
    (case "division by zero"
      (input 10 0)
      (expect (err "Division by zero")))
    
    (case "negative result"
      (input -10 2)
      (expect (ok -5)))
    
    (case "negative divisor"
      (input 10 -2)
      (expect (ok -5))))
  
  (fn factorial ((n i32)) -> result<i32,string>
    (if (call op_lt_i32 n 0)
      (ret (err "Negative input"))
      (if (call op_eq_i32 n 0)
        (ret (ok 1))
        (match-result (call factorial (call op_sub_i32 n 1))
          ((ok prev) (ret (ok (call op_mul_i32 n prev))))
          ((err e) (ret (err e)))))))
  
  (test-spec factorial
    (case "base case zero"
      (input 0)
      (expect (ok 1)))
    
    (case "base case one"
      (input 1)
      (expect (ok 1)))
    
    (case "small positive"
      (input 5)
      (expect (ok 120)))
    
    (case "negative input"
      (input -1)
      (expect (err "Negative input"))))
  
  (property-spec factorial
    (property "non-negative input yields positive result"
      (forall ((n i32) (constraint (and (call op_ge_i32 n 0) (call op_le_i32 n 12))))
        (match-result (call factorial n)
          ((ok result) (assert (call op_gt_i32 result 0)))
          ((err _) (assert-fail)))))
    
    (property "factorial is monotonically increasing"
      (forall ((n i32) (constraint (and (call op_ge_i32 n 1) (call op_le_i32 n 11))))
        (match-result (call factorial n)
          ((ok r1)
            (match-result (call factorial (call op_add_i32 n 1))
              ((ok r2) (assert (call op_gt_i32 r2 r1)))
              ((err _) (assert-fail))))
          ((err _) (assert-fail))))))
  
  (fn safe_get ((arr array<i32>) (idx i32)) -> option<i32>
    (if (call op_lt_i32 idx 0)
      (ret (none))
      (if (call op_ge_i32 idx (call array_len arr))
        (ret (none))
        (ret (some (call array_get arr idx))))))
  
  (test-spec safe_get
    (case "valid index"
      (setup (set arr array<i32> (call array_from_list (list 10 20 30 40))))
      (input arr 2)
      (expect (some 30)))
    
    (case "negative index"
      (setup (set arr array<i32> (call array_from_list (list 10 20 30))))
      (input arr -1)
      (expect (none)))
    
    (case "index too large"
      (setup (set arr array<i32> (call array_from_list (list 10 20))))
      (input arr 5)
      (expect (none)))
    
    (case "empty array"
      (setup (set arr array<i32> (call array_new)))
      (input arr 0)
      (expect (none))))
  
  (meta-note "HTTP fetch with mocking example")
  (fn fetch_user ((user_id string)) -> result<string,string>
    (set url string (call str_concat "https://api.example.com/users/" user_id))
    (match-result (call http_get url)
      ((ok resp)
        (if (call op_eq_i32 (call http_status resp) 200)
          (ret (ok (call http_body resp)))
          (if (call op_eq_i32 (call http_status resp) 404)
            (ret (err "User not found"))
            (ret (err "HTTP error")))))
      ((err e) (ret (err "Network error")))))
  
  (test-spec fetch_user
    (case "successful fetch"
      (mock (http_get "https://api.example.com/users/123")
            (ok (http_response 200 "{\"id\":\"123\",\"name\":\"Alice\"}")))
      (input "123")
      (expect (ok "{\"id\":\"123\",\"name\":\"Alice\"}")))
    
    (case "user not found"
      (mock (http_get "https://api.example.com/users/999")
            (ok (http_response 404 "Not Found")))
      (input "999")
      (expect (err "User not found")))
    
    (case "network error"
      (mock (http_get "https://api.example.com/users/456")
            (err "Connection timeout"))
      (input "456")
      (expect (err "Network error"))))
)
