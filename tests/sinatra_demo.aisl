(mod sinatra_demo
  (fn extract_path ((request string)) -> string
    (set lines array (call string_split request "\n"))
    (set line_count i32 (call array_length lines))
    (if (call op_gt_i32 line_count 0)
      (then
        (set first_line string (call array_get lines 0))
        (set parts array (call string_split first_line " "))
        (set part_count i32 (call array_length parts))
        (if (call op_gt_i32 part_count 1)
          (then
            (ret (call array_get parts 1)))
          (else
            (ret "/"))))
      (else
        (ret "/"))))

  (fn build_http_response ((status string) (content_type string) (body string)) -> string
    (set response string (call string_concat "HTTP/1.1 " status))
    (set response string (call string_concat response "\r\n"))
    (set response string (call string_concat response "Content-Type: "))
    (set response string (call string_concat response content_type))
    (set response string (call string_concat response "\r\n"))
    (set response string (call string_concat response "Content-Length: "))
    (set body_len i32 (call string_length body))
    (set body_len_str string (call string_from_i32 body_len))
    (set response string (call string_concat response body_len_str))
    (set response string (call string_concat response "\r\n"))
    (set response string (call string_concat response "Connection: close\r\n"))
    (set response string (call string_concat response "\r\n"))
    (set response string (call string_concat response body))
    (ret response))

  (fn handle_hello_html () -> string
    (set body string "<html><body>Hello from AISL</body></html>")
    (ret (call build_http_response "200 OK" "text/html" body)))

  (fn handle_hello_json () -> string
    (set body string "{\"message\": \"Hello from AISL\"}")
    (ret (call build_http_response "200 OK" "application/json" body)))

  (fn handle_not_found () -> string
    (set body string "<html><body><h1>404 Not Found</h1></body></html>")
    (ret (call build_http_response "404 Not Found" "text/html" body)))

  (fn route_request ((path string)) -> string
    (if (call str_eq path "/hello")
      (then
        (ret (call handle_hello_html)))
      (else
        (if (call str_eq path "/hello.json")
          (then
            (ret (call handle_hello_json)))
          (else
            (ret (call handle_not_found)))))))

  (fn handle_connection ((client_sock string)) -> i32
    (set request string (call tcp_receive client_sock 4096))
    (set path string (call extract_path request))
    (set response string (call route_request path))
    (set sent i32 (call tcp_send client_sock response))
    (call tcp_close client_sock)
    (ret 0))

  (fn start_server ((port i32)) -> i32
    (call print "Starting AISL web server on port 8080...")
    (set server_sock string (call tcp_listen port))
    (call print "Server listening on port 8080")
    (call print "Available routes:")
    (call print "  http://localhost:8080/hello")
    (call print "  http://localhost:8080/hello.json")
    (label accept_loop)
    (set client_sock string (call tcp_accept server_sock))
    (call print "New connection accepted")
    (call handle_connection client_sock)
    (goto accept_loop)
    (ret 0))

  (fn main () -> i32
    (call start_server 8080)
    (ret 0)))
