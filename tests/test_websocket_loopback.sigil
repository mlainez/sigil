(module test_websocket_loopback

  (fn start_ws_server port int -> channel
    (set vm_path string "./interpreter/_build/default/vm.exe")
    (set server_args array (array_new))
    (array_push server_args "tests/ws_echo_server.sigil")
    (set server channel (process_spawn vm_path server_args))
    (set port_str string (string_from_int port))
    (set port_line string (string_concat port_str "\n"))
    (process_write server port_line)
    (set attempts int 0)
    (while (lt attempts 50)
      (set line string (process_read server))
      (set line_len int (string_length line))
      (if (gt line_len 0)
        (ret server))
      (sleep 100)
      (set attempts int (add attempts 1)))
    (ret server))

  (fn test_ws_echo -> int
    (set port int 18801)
    (set server channel (start_ws_server port))
    (set ws socket (ws_connect "127.0.0.1" port "/"))
    (set msg string "hello websocket")
    (ws_send ws msg)
    (set received string (ws_receive ws))
    (ws_close ws)
    (process_wait server)
    (if (string_equals received msg)
      (ret 1))
    (ret 0))

  (fn test_ws_multiple_messages -> int
    (set port int 18802)
    (set server channel (start_ws_server port))
    (set ws socket (ws_connect "127.0.0.1" port "/"))
    (set msg1 string "first message")
    (ws_send ws msg1)
    (set got1 string (ws_receive ws))
    (set msg2 string "second message")
    (ws_send ws msg2)
    (set got2 string (ws_receive ws))
    (set msg3 string "third message")
    (ws_send ws msg3)
    (set got3 string (ws_receive ws))
    (ws_close ws)
    (process_wait server)
    (set ok1 bool (string_equals got1 msg1))
    (set ok2 bool (string_equals got2 msg2))
    (set ok3 bool (string_equals got3 msg3))
    (if ok1
      (if ok2
        (if ok3
          (ret 1))))
    (ret 0))

  (fn test_ws_large_message -> int
    (set port int 18803)
    (set server channel (start_ws_server port))
    (set ws socket (ws_connect "127.0.0.1" port "/"))
    (set msg string "ABCDEFGHIJ")
    (set i int 0)
    (while (lt i 6)
      (set msg string (string_concat msg msg))
      (set i int (add i 1)))
    (set expected_len int (string_length msg))
    (ws_send ws msg)
    (set received string (ws_receive ws))
    (set recv_len int (string_length received))
    (ws_close ws)
    (process_wait server)
    (if (eq recv_len expected_len)
      (ret 1))
    (ret 0))

  (test-spec test_ws_echo
    (case "WebSocket echo via loopback"
      (input)
      (expect 1)))

  (test-spec test_ws_multiple_messages
    (case "multiple WebSocket messages echoed correctly"
      (input)
      (expect 1)))

  (test-spec test_ws_large_message
    (case "large WebSocket message (640 bytes) echoed correctly"
      (input)
      (expect 1)))

  (meta-note "Tests WebSocket send/receive via loopback using subprocess echo server"))
