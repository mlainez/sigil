(mod test_weather_api
  (fn fetch_weather ((url string)) -> string
    (ret (call http_get url)))
  
  (test-spec fetch_weather
    (case "fetch weather data from wttr.in"
      (mock (http_get "http://wttr.in/Paris?format=j1") "weather_response")
      (input "http://wttr.in/Paris?format=j1")
      (expect "weather_response")))
  
  (fn get_weather_status ((response string)) -> i32
    (ret (call http_get_status response)))
  
  (test-spec get_weather_status
    (case "get weather API status code"
      (mock (http_get_status "weather_response") 200)
      (input "weather_response")
      (expect 200)))
  
  (fn get_weather_body ((response string)) -> string
    (ret (call http_get_body response)))
  
  (test-spec get_weather_body
    (case "get weather response body"
      (mock (http_get_body "weather_response") "{\"current_condition\":[{\"temp_C\":\"15\"}]}")
      (input "weather_response")
      (expect "{\"current_condition\":[{\"temp_C\":\"15\"}]}")))
  
  (fn get_body_length ((body string)) -> i32
    (ret (call len body)))
  
  (test-spec get_body_length
    (case "get length of response body"
      (mock (string_length "{\"weather\":\"sunny\"}") 21)
      (input "{\"weather\":\"sunny\"}")
      (expect 21)))
  
  (fn parse_weather_json ((json_str string)) -> json
    (ret (call json_parse json_str)))
  
  (test-spec parse_weather_json
    (case "parse weather JSON string"
      (mock (json_parse "{\"current_condition\":[{\"temp_C\":\"15\"}]}") "weather_json")
      (input "{\"current_condition\":[{\"temp_C\":\"15\"}]}")
      (expect "weather_json")))
  
  (fn get_json_type ((json_data json)) -> string
    (ret (call json_type json_data)))
  
  (test-spec get_json_type
    (case "get type of weather JSON"
      (mock (json_type "weather_json") "object")
      (input "weather_json")
      (expect "object")))
  
  (fn get_json_field ((json_data json) (field string)) -> json
    (ret (call json_get json_data field)))
  
  (test-spec get_json_field
    (case "get current_condition field"
      (mock (json_get "weather_obj" "current_condition") "condition_array")
      (input "weather_obj" "current_condition")
      (expect "condition_array")))
  
  (fn get_field_type ((field_data json)) -> string
    (ret (call json_type field_data)))
  
  (test-spec get_field_type
    (case "get type of condition field"
      (mock (json_type "condition_array") "array")
      (input "condition_array")
      (expect "array")))
  
  (meta-note "Tests weather API with atomic functions - each function has single external call and single mock"))
