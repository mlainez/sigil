(module test_runner
  (import string_utils)
  (import conversion)
  
  (fn print_banner -> int
    (call print "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
    (call print "â•‘     AISL Test Framework Runner         â•‘")
    (call print "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    (ret 0))
  
  (fn print_separator -> int
    (call print "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    (ret 0))
  
  (fn compile_test file string -> bool
    (set output string "/tmp/test_output.aislc")
    
    (set args array (call array_new 10))
    (call array_push args file)
    (call array_push args output)
    (call array_push args "2>&1")
    (call array_push args ">/dev/null")
    
    (set exit_code int (call process_exec "./compiler/c/bin/aislc" args))
    
    (set success bool (call eq exit_code 0))
    (ret success))
  
  (fn extract_test_name file string -> string
    (set name string (call string_replace file "tests/" ""))
    (set name string (call string_replace name ".aisl" ""))
    (ret name))
  
  (fn run_single_test file string passed_ptr int failed_ptr int -> int
    (set test_name string (call extract_test_name file))
    (set success bool (call compile_test file))
    
    (set msg string "")
    (if success
      (set msg string "  âœ“ ")
      (set msg string (call string_concat msg test_name))
      (call print msg)
      (ret 1))
    
    (set msg string "  âœ— ")
    (set msg string (call string_concat msg test_name))
    (call print msg)
    (ret 0))
  
  (fn get_test_files -> array
    (set all_files array (call dir_list "tests"))
    (set test_files array (call array_new 200))
    
    (set i int 0)
    (set len int (call array_length all_files))
    
    (while (call lt i len)
      (set filename string (call array_get all_files i))
      
      (set is_test bool (call string_starts_with filename "test_"))
      (if is_test
        (set is_aisl bool (call string_ends_with filename ".aisl"))
        (if is_aisl
          (set full_path string "tests/")
          (set full_path string (call string_concat full_path filename))
          (call array_push test_files full_path)))
      
      (set i int (call add i 1)))
    
    (ret test_files))
  
  (fn print_summary passed int failed int total int -> int
    (call print "")
    (call print_separator)
    (call print "           TEST SUMMARY")
    (call print_separator)
    
    (set passed_str string (call string_from_int passed))
    (set failed_str string (call string_from_int failed))
    (set total_str string (call string_from_int total))
    
    (set msg string "Total Tests:  ")
    (set msg string (call string_concat msg total_str))
    (call print msg)
    
    (set msg string "âœ“ Passed:     ")
    (set msg string (call string_concat msg passed_str))
    (call print msg)
    
    (set has_failures bool (call gt failed 0))
    (if has_failures
      (set msg string "âœ— Failed:     ")
      (set msg string (call string_concat msg failed_str))
      (call print msg))
    
    (call print_separator)
    
    (set all_passed bool (call eq failed 0))
    (if all_passed
      (call print "")
      (call print "ðŸŽ‰ ALL TESTS PASSED!")
      (ret 0))
    
    (call print "")
    (call print "âŒ SOME TESTS FAILED")
    (ret 1))
  
  (fn main -> int
    (call print_banner)
    (call print "")
    (call print "Discovering test files...")
    
    (set files array (call get_test_files))
    (set total int (call array_length files))
    
    (set is_empty bool (call eq total 0))
    (if is_empty
      (call print "No test files found!")
      (ret 1))
    
    (set total_str string (call string_from_int total))
    (set msg string "Found ")
    (set msg string (call string_concat msg total_str))
    (set msg string (call string_concat msg " test files"))
    (call print msg)
    (call print "")
    
    (set passed int 0)
    (set failed int 0)
    (set i int 0)
    
    (while (call lt i total)
      (set file string (call array_get files i))
      (set result int (call run_single_test file 0 0))
      
      (set is_pass bool (call eq result 1))
      (if is_pass
        (set passed int (call add passed 1)))
      (if (call not is_pass)
        (set failed int (call add failed 1)))
      
      (set i int (call add i 1)))
    
    (set exit_code int (call print_summary passed failed total))
    (ret exit_code))
  
  (meta-note "Pure AISL test runner for test-spec framework. Uses dir_list to discover tests, process_exec to compile them, reports results. Demonstrates AISL dogfooding principle - if it CAN be in AISL, it MUST be in AISL!"))
